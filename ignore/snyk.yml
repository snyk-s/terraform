
# name: Snyk Security Scan

# on:
#   push:
#     branches:
#       - main
#       - dev
#   pull_request:
#     branches:
#       - main
#       - dev

# permissions:
#   contents: read
#   pull-requests: write

# jobs:
#   snyk:
#     runs-on: ubuntu-latest
    
#     steps:
#       - name: Checkout code
#         uses: actions/checkout@v4

#       - name: Set up Node.js (required for Snyk CLI)
#         uses: actions/setup-node@v4
#         with:
#           node-version: '20'

#       - name: Install Snyk CLI and HTML reporter
#         run: |
#           npm install -g snyk
#           npm install -g snyk-to-html

#       - name: Run Snyk test for code dependencies
#         id: snyk-code
#         continue-on-error: true
#         run: |
#           snyk test --all-projects --json > snyk-code-results.json || true
#           snyk-to-html -i snyk-code-results.json -o snyk-code-results.html || true
#           snyk test --all-projects > snyk-code-results.txt || true
#           [ -f snyk-code-results.json ] || touch snyk-code-results.json
#           [ -f snyk-code-results.txt ] || touch snyk-code-results.txt
#           [ -f snyk-code-results.html ] || touch snyk-code-results.html
#           echo "===== Snyk Code Test Results ====="
#           cat snyk-code-results.txt

#       - name: Run Snyk test for IaC
#         id: snyk-iac
#         continue-on-error: true
#         run: |
#           snyk iac test --json > snyk-iac-results.json || true
#           snyk iac test > snyk-iac-results.txt || true
#           [ -f snyk-iac-results.json ] || touch snyk-iac-results.json
#           [ -f snyk-iac-results.txt ] || touch snyk-iac-results.txt
#           echo "===== Snyk IaC Test Results ====="
#           cat snyk-iac-results.txt

#       - name: Combine Snyk Results
#         run: |
#           echo '### Snyk Code Test Results' > snyk-results.md
#           cat snyk-code-results.txt >> snyk-results.md
#           echo -e '\n---\n' >> snyk-results.md
#           echo '### Snyk IaC Test Results' >> snyk-results.md
#           cat snyk-iac-results.txt >> snyk-results.md

#       - name: Upload Snyk Results as Artifacts
#         uses: actions/upload-artifact@v4
#         with:
#           name: snyk-results
#           path: |
#             snyk-code-results.json
#             snyk-code-results.html
#             snyk-iac-results.json
#             snyk-results.md

#       - name: Post Snyk Results as PR Comment
#         if: github.event_name == 'pull_request'
#         uses: marocchino/sticky-pull-request-comment@v2
#         with:
#           path: snyk-results.md
    
#     env:
#       SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
#       SNYK_API: https://api.us.snyk.io



name: Snyk Infrastructure as Code
on: push
jobs:
  snyk:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Run Snyk to check configuration files for security issues
        # Snyk can be used to break the build when it detects security issues.
        # In this case we want to upload the issues to GitHub Code Scanning
        continue-on-error: true
        uses: snyk/actions/iac@master
        env:
          # In order to use the Snyk Action you will need to have a Snyk API token.
          # More details in https://github.com/snyk/actions#getting-your-snyk-token
          # or you can signup for free at https://snyk.io/login
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
          SNYK_API: https://api.us.snyk.io











          name: Snyk IaC Scan

on:
  pull_request:
    branches:
      - main
      - master

jobs:
  snyk-iac:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Run Snyk to check configuration files for security issues
        id: snyk-iac
        uses: snyk/actions/iac@master
        continue-on-error: true
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
          SNYK_API: https://api.us.snyk.io
        with:
          args: --json-file-output=snyk-iac-output.json

      - name: Debug - Print Snyk IaC JSON output
        if: always()
        run: |
          echo "===== snyk-iac-output.json ====="
          cat snyk-iac-output.json || echo "No output file found"
          echo "==============================="

      - name: Summarize Snyk IaC results for PR comment
        id: summarize
        run: |
          if [ -f snyk-iac-output.json ]; then
            count=$(jq '[.[].infrastructureAsCodeIssues[]?] | length' snyk-iac-output.json)
            if [ "$count" -eq 0 ]; then
              echo "No issues found." > snyk-iac-summary.txt
            else
              echo "Found $count IaC issues:" > snyk-iac-summary.txt
              jq -r '.[] | select(.infrastructureAsCodeIssues != null and (.infrastructureAsCodeIssues | length > 0)) | .targetFile as $file | .infrastructureAsCodeIssues[] | "- [" + $file + "] " + .title + " (" + .severity + ")"' snyk-iac-output.json >> snyk-iac-summary.txt
            fi
          else
            echo "No Snyk output found." > snyk-iac-summary.txt
          fi

      - name: Post Snyk IaC results as PR comment
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const output = fs.readFileSync('snyk-iac-summary.txt', 'utf8');
            const body = [
              '## :mag: Snyk Infrastructure as Code (IaC) Scan Results',
              '```',
              output.length > 65000 ? output.slice(0, 65000) + '\n...truncated...' : output,
              '```',
              '_Full JSON report is available as a workflow artifact._'
            ].join('\n');
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body
            });

      - name: Upload Snyk IaC JSON report as artifact
        uses: actions/upload-artifact@v4
        with:
          name: snyk-iac-json-report
          path: snyk-iac-output.json